# ポケモンカード取引サイト改修仕様書（0723_2）

## 1. はじめに

本ドキュメントは、請求書（納品書）の永続的なデータ管理機能を追加するための改修仕様を定義するものです。

## 2. 改修の背景

現状のシステムでは、納品書は作成の都度PDFとして出力されるのみで、過去に作成した内容を再利用したり、一覧で管理したりすることができません。ユーザーの利便性を高め、業務を効率化するために、作成した納品書の情報をデータベースに保存し、後から参照・編集・削除できる機能が求められています。

## 3. 要件定義

### 3.1. データベースの導入と設定

*   **目的:** 請求書データを永続的に保存するための基盤を構築する。
*   **改修内容:**
    *   ORM（Object-Relational Mapping）ツールとして `Prisma` を導入します。
    *   データベースとして、開発・導入が容易な `SQLite` を採用します。
    *   `Prisma` を用いて、アプリケーションとデータベースの接続設定を行います。

### 3.2. 請求書データモデルの定義

*   **目的:** データベースに保存する請求書情報の構造を定義する。
*   **改修内容:** `Prisma` のスキーマ定義ファイルに必要なモデルを追加します。
    *   **Invoice (請求書) モデル:**
        *   `id`: 一意のID（自動採番、主キー）
        *   `invoiceNumber`: 請求書番号（例: INV-20230723-001）
        *   `createdAt`: 作成日時
        *   `updatedAt`: 更新日時
        *   `totalAmount`: 合計金額
        *   `totalQuantity`: 合計数量
    *   **InvoiceItem (請求書明細) モデル:**
        *   `id`: 一意のID（自動採番、主キー）
        *   `invoiceId`: どの請求書に属するかを示すID (Invoiceモデルへのリレーション)
        *   `cardId`: 商品ID（カードの識別子）
        *   `title`: 商品タイトル
        *   `rarity`: レアリティ
        *   `unitPrice`: 単価
        *   `quantity`: 数量
        *   `subtotal`: 小計

### 3.3. 請求書のCRUD機能の実装

バックエンドに、データベースを操作するためのAPI（Application Programming Interface）を実装します。

#### 3.3.1. 作成 (Create)

*   **機能:** 新しい請求書をデータベースに保存する。
*   **動作:** ユーザーが「納品書」ページで「保存」ボタンを押すと、現在の納品書リストの内容（各カードとその数量）がデータベースに書き込まれる。保存時に一意の請求書番号が採番される。

#### 3.3.2. 一覧表示 (Read)

*   **機能:** 保存済みの請求書を一覧で表示する。
*   **動作:**
    *   新たに「請求書一覧」ページを作成します。
    *   このページでは、保存されている全ての請求書がリスト形式で表示されます。
    *   各行には、「請求書番号」「作成日」「合計金額」などが表示されます。
    *   各行には、「編集」「削除」「複製」「PDF出力」ボタンが設置されます。

#### 3.3.3. 更新 (Update)

*   **機能:** 既存の請求書の内容を編集し、更新する。
*   **動作:**
    *   「請求書一覧」ページで「編集」ボタンを押すと、その請求書の内容が読み込まれた状態で「納品書」ページに遷移します。
    *   ユーザーはカードの数量変更や削除を行い、「更新」ボタンで変更内容をデータベースに反映させます。

#### 3.3.4. 削除 (Delete)

*   **機能:** 既存の請求書をデータベースから削除する。
*   **動作:** 「請求書一覧」ページで「削除」ボタンを押し、確認ダイアログで承認すると、対象の請求書データがデータベースから完全に削除される。

### 3.4. 追加機能

#### 3.4.1. 複製 (Clone)

*   **機能:** 既存の請求書を元に、新しい請求書を複製作成する。
*   **動作:** 「請求書一覧」ページで「複製」ボタンを押すと、選択した請求書と全く同じ内容の新しい請求書が作成され、編集可能な状態で「納品書」ページが開く。請求書番号は新しく採番される。

## 4. 技術選定

*   **データベース:** SQLite
*   **ORM:** Prisma
*   **その他:** Next.js API Routes (バックエンド処理)

## 5. その他

*   本改修は、まずバックエンドのAPI実装から着手し、その後フロントエンドの画面実装を進める計画とします。 