# ポケサーチ 要件定義書 (250805_1)

## 1. 概要

本ドキュメントは、ポケモンカード買取価格検索・納品書作成システム「ポケサーチ」を新規に構築する際の要件を定義するものである。

### 1.1. 背景と目的

既存システムは、機能追加と改修を重ねた結果、システム全体の仕様が複雑化している。本要件定義書は、これまでの改修履歴（UI/UX改善、データ管理方法の変更、納品書管理機能の追加など）で培われた仕様を集約・整理し、システムの再構築における開発の指針とすることを目的とする。

### 1.2. プロジェクトのゴール

- 最新の技術スタックを用いて、保守性と拡張性の高いシステムを再構築する。
- PC、スマートフォン、タブレットなど、多様なデバイスで快適に利用できるUI/UXを提供する。
- 効率的なカード検索から納品書作成、管理までの一連の業務フローをシームレスに支援する。

## 2. 機能要件

### 2.1. カード検索・表示機能

ユーザーが目的のポケモンカードを効率的に探し、詳細情報を確認するための機能。

| 機能名 | 概要 | 詳細 |
| :--- | :--- | :--- |
| **カード検索** | 型番やカード名でシステムに登録されたカードを検索する。 | ・インクリメンタルサーチを実装し、入力中に候補を表示する。<br>・F1キーで検索ボックスにフォーカスするショートカットを提供する。 |
| **カード一覧表示** | 検索結果を一覧で表示する。 | ・一覧には「商品タイトル」「型番」「レアリティ」「買取価格」を表示する。<br>・キーボードの上下矢印キー、またはマウスクリック（タップ）でカードを選択できる。<br>・スマートフォンでは、上下のフリック（スワイプ）操作でもカードを選択できる。 |
| **カード詳細表示** | 選択したカードの拡大画像と詳細情報を表示する。 | ・画像が見つからない場合は、規定のプレースホルダー画像を表示する。 |

### 2.2. 納品書作成機能

検索したカードをリストに追加し、買取依頼用の納品書を作成・管理する機能。

| 機能名 | 概要 | 詳細 |
| :--- | :--- | :--- |
| **納品書へのカード追加** | カード一覧から数量を指定して納品書リストに追加する。 | ・各カード項目に「納品書へ追加」ボタンを設置する。 |
| **手動での項目追加** | システム未登録の商品を、手動で納品書リストに追加する。 | ・「商品タイトル」「型番」「レアリティ」「買取価格」「数量」を入力するフォームを提供する。<br>・入力された情報は、現在の納品書セッションにのみ保持され、マスタデータには影響しない。<br>・必須項目（タイトル、価格、数量）の入力チェックを行う。 |
| **納品書リストの編集** | 納品書リスト内のカード数量を変更、またはリストから削除する。 | ・数量変更や削除は即座に合計金額・合計数量に反映される。 |
| **納品書のPDF出力** | 作成した納品書をPDF形式でダウンロードする。 | ・A4サイズで整形されたレイアウトで出力する。<br>・日本語フォントを埋め込み、環境に依存しない表示を保証する（文字化け防止）。<br>・PCおよび主要なモバイルブラウザで正常に表示・ダウンロードできる。 |

### 2.3. 納品書管理機能 (永続化)

作成した納品書をデータベースに保存し、後から再利用するための機能。

| 機能名 | 概要 | 詳細 |
| :--- | :--- | :--- |
| **納品書の保存 (Create)** | 作成中の納品書をデータベースに保存する。 | ・保存時に一意の請求書番号（例: `INV-YYYYMMDD-NNN`）を採番する。 |
| **保存済み納品書の一覧表示 (Read)** | 保存した納品書を一覧で表示する。 | ・「請求書一覧」ページを設ける。<br>・一覧には「請求書番号」「作成日時」「合計金額」「合計数量」などを表示する。<br>・各項目には「編集」「削除」「複製」「PDF出力」の操作ボタンを設置する。 |
| **納品書の編集 (Update)** | 保存済みの納品書を編集し、変更を保存する。 | ・編集対象の納品書データを読み込み、納品書作成画面で内容を更新する。 |
| **納品書の削除 (Delete)** | 保存済みの納品書をデータベースから削除する。 | ・削除前に確認ダイアログを表示する。 |
| **納品書の複製 (Clone)** | 既存の納品書をコピーして、新しい納品書を作成する。 | ・複製元のデータが入力された状態で、編集可能な納品書作成画面を開く。請求書番号は新たに採番する。 |

## 3. 非機能要件

### 3.1. UI/UX

| 項目 | 要件 |
| :--- | :--- |
| **レスポンシブデザイン** | PC、タブレット、スマートフォンの各画面幅に最適化されたレイアウトで表示する。 |
| **ナビゲーション** | ・納品書ページからカード検索ページへ戻るなど、サイト内の主要ページ間をスムーズに遷移できる導線を確保する。 |

### 3.2. データ管理・技術スタック

| 項目 | 要件 |
| :--- | :--- |
| **商品マスタデータ** | ・Googleスプレッドシートから動的に取得する。<br>・**シートID:** `1XhLcAypoY18yQiUWpd0T-9fNpAd3dCf2NEPVRy3iW1E`<br>・シートは一般公開設定とし、認証不要でCSV形式で取得する。 |
| **商品画像データ** | ・画像URLを管理する別のGoogleスプレッドシートから取得する。<br>・**シートID:** `1e1QaldVK3sueAw_t90fuGL8p-GdhLMPuRivPqdFk9lg`<br>・スプレッドシートの`IMAGE`関数から正規表現でURLを抽出する。<br>・「型番」と「カード名」をキーにして、商品マスタと画像URLを紐付ける。 |
| **納品書データ** | ・データベース(SQLite)に永続化する。<br>・ORMとしてPrismaを使用し、データベース操作を行う。 |
| **フロントエンド** | ・Next.js (React) を使用して構築する。 |
| **バックエンド** | ・Next.js API Routes (または同等の機能) を使用して、データベース操作APIを実装する。 |

### 3.3. パフォーマンス

| 項目 | 要件 |
| :--- | :--- |
| **データ取得** | ・商品マスタデータは、サーバーサイドで取得・キャッシュし、ページの表示速度を最適化する。 |

## 4. データモデル定義 (Prismaスキーマ)

```prisma
// 請求書モデル
model Invoice {
  id              Int           @id @default(autoincrement())
  invoiceNumber   String        @unique
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  totalAmount     Int
  totalQuantity   Int
  items           InvoiceItem[]
}

// 請求書明細モデル
model InvoiceItem {
  id          Int      @id @default(autoincrement())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
  invoiceId   Int
  cardId      String   // 商品を特定するための一意のID（例: 型番）
  title       String
  rarity      String?
  unitPrice   Int
  quantity    Int
  subtotal    Int
}
```
